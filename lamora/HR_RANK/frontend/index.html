<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resume Screening Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 900px; margin-top: 40px; }
        .candidate-card { margin-bottom: 24px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">ğŸ“„ Resume Screening Assistant</h1>
    <form id="resumeForm">
        <div class="mb-3">
            <label for="jobDesc" class="form-label">ğŸ“ Enter Job Description</label>
            <textarea class="form-control" id="jobDesc" rows="5" required></textarea>
        </div>
        <div class="mb-3">
            <label for="resumeFiles" class="form-label">ğŸ“ Upload Resumes (PDF)</label>
            <input class="form-control" type="file" id="resumeFiles" accept=".pdf" multiple required>
        </div>
        <button type="submit" class="btn btn-primary">ğŸ” Analyze Resumes</button>
    </form>
    <div id="results" class="mt-5"></div>
</div>

<script>
document.getElementById('resumeForm').onsubmit = async function(e) {
    e.preventDefault();
    const jobDesc = document.getElementById('jobDesc').value.trim();
    const files = document.getElementById('resumeFiles').files;
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = "";

    if (!jobDesc || files.length === 0) {
        resultsDiv.innerHTML = `<div class="alert alert-warning">Please upload resumes and enter a job description.</div>`;
        return;
    }

    let allCandidates = [];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('job_description', jobDesc);

        resultsDiv.innerHTML += `<div class="mb-2">Processing <b>${file.name}</b>...</div>`;

        try {
            const response = await fetch('http://localhost:8000/parse_resume/', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (response.ok) {
                let candidates = data.result;
                if (!Array.isArray(candidates)) candidates = [candidates];
                allCandidates = allCandidates.concat(candidates);
            } else {
                resultsDiv.innerHTML += `<div class="alert alert-danger">Error processing ${file.name}: ${data.error || "Unknown error"}</div>`;
            }
        } catch (err) {
            resultsDiv.innerHTML += `<div class="alert alert-danger">Error processing ${file.name}: ${err}</div>`;
        }
    }

    if (allCandidates.length > 0) {
        // Sort by ranking if available
        allCandidates.sort((a, b) => (a.ranking || 99) - (b.ranking || 99));
        let html = `<h2 class="mb-4">ğŸ† Top Candidates</h2>`;
        allCandidates.forEach((candidate, idx) => {
            html += `
            <div class="card candidate-card">
                <div class="card-body">
                    <h5 class="card-title">ğŸ§‘ ${candidate.name || "N/A"} <span class="badge bg-secondary">Rank ${candidate.ranking ?? "?"}</span></h5>
                    <p class="card-text"><b>ğŸ“§ Email:</b> ${candidate.email || "N/A"}</p>
                    <p class="card-text"><b>ğŸ“ Why Top:</b> ${candidate.why_top || "Not provided"}</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="scheduleMeeting('${candidate.name}', '${candidate.email}', this)">ğŸ“… Schedule Meeting</button>
                        <button class="btn btn-info" onclick="sendMail('${candidate.name}', '${candidate.email}', this)">âœ‰ï¸ Send Mail</button>
                    </div>
                </div>
            </div>
            `;
        });
        resultsDiv.innerHTML = html;
    } else {
        resultsDiv.innerHTML += `<div class="alert alert-warning">No candidates found.</div>`;
    }
};

// Helper functions for buttons
async function scheduleMeeting(name, email, btn) {
    btn.disabled = true;
    btn.textContent = "Scheduling...";
    try {
        const response = await fetch('http://localhost:8000/schedule_meeting/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, email})
        });
        if (response.ok) {
            btn.textContent = "âœ… Meeting Scheduled";
            btn.classList.remove("btn-success");
            btn.classList.add("btn-secondary");
        } else {
            btn.textContent = "âŒ Failed";
            btn.disabled = false;
        }
    } catch {
        btn.textContent = "âŒ Failed";
        btn.disabled = false;
    }
}

async function sendMail(name, email, btn) {
    btn.disabled = true;
    btn.textContent = "Sending...";
    try {
        const response = await fetch('http://localhost:8000/send_mail/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, email})
        });
        if (response.ok) {
            btn.textContent = "âœ… Mail Sent";
            btn.classList.remove("btn-info");
            btn.classList.add("btn-secondary");
        } else {
            btn.textContent = "âŒ Failed";
            btn.disabled = false;
        }
    } catch {
        btn.textContent = "âŒ Failed";
        btn.disabled = false;
    }
}
</script>
</body>
</html>